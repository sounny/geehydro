// Define the Area of Interest (AOI) for Gainesville, FL.
var GainesvilleAOI = ee.Geometry.Rectangle(-82.5, 29.5, -82.2, 29.8);

// Load the HydroSHEDS elevation model and clip it to the AOI.
var elevation = ee.Image("WWF/HydroSHEDS/03VFDEM").clip(GainesvilleAOI);

// Load the HydroSHEDS flow direction reference and clip it to the AOI.
var reference = ee.Image("WWF/HydroSHEDS/03DIR").clip(GainesvilleAOI);

/**
 * Calculate flow direction using the D8 algorithm.
 *
 * This function calculates the flow direction for each cell in a Digital
 * Elevation Model (DEM) using the D8 algorithm. Each cell drains to the
 * neighboring cell with the steepest downward slope.
 *
 * Direction codes follow the standard D8 clockwise encoding:
 *   1 = E, 2 = SE, 4 = S, 8 = SW, 16 = W, 32 = NW, 64 = N, 128 = NE
 *
 * Cells with no lower neighbor are set to 0.
 *
 * @param {ee.Image} dem The Digital Elevation Model.
 * @return {ee.Image} An image with the flow direction for each cell.
 */
var calculateFlowDirectionD8 = function(dem) {
  // Define the 8 directions for the D8 algorithm.
  var directions = ee.Image.constant([128, 1, 2, 4, 8, 16, 32, 64]).byte();

  // Calculate the slope to each of the 8 neighbors.
  var slope = ee.Terrain.slope(dem);

  // Find the direction with the steepest downward slope.
  var flowDirection = slope.multiply(-1).atan2(slope).multiply(180 / Math.PI).add(180);

  // Convert the continuous flow direction to D8 directions.
  var d8 = flowDirection.divide(45).round().mod(8);

  // Encode the D8 directions.
  return directions.slice(d8, 1, 2).rename('flowDirection');
};

// Calculate the flow direction using the D8 algorithm.
var flowDirection = calculateFlowDirectionD8(elevation);

// Add the flow direction and reference layers to the map.
Map.addLayer(flowDirection, {min: 1, max: 128, palette: [
  '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff', '#ffffff', '#000000'
]}, 'Flow Direction');
Map.addLayer(reference, {min: 1, max: 128}, 'Reference');

// Center the map on the AOI.
Map.centerObject(GainesvilleAOI, 10);
